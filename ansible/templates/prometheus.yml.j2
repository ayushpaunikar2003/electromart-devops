global:
  scrape_interval: 15s

scrape_configs:
  - job_name: 'prometheus'
    static_configs:
      - targets: ['localhost:9090']

  # Scrape Node Exporter (CPU/RAM) from ALL servers
  # Uses 'monitoring_ip' if set (for Bastion), otherwise 'ansible_host'
  - job_name: 'node_exporter'
    static_configs:
      - targets:
{% for host in groups['all'] %}
        - '{{ hostvars[host].monitoring_ip | default(hostvars[host].ansible_host) }}:9100'
{% endfor %}

  # Scrape cAdvisor (Docker Stats) from ALL servers
  - job_name: 'cadvisor'
    static_configs:
      - targets:
{% for host in groups['all'] %}
        - '{{ hostvars[host].monitoring_ip | default(hostvars[host].ansible_host) }}:8080'
{% endfor %}

  # Scrape Backend App Metrics (Custom Node.js metrics)
  - job_name: 'backend'
    metrics_path: /metrics
    static_configs:
      - targets:
{% for host in groups['app'] %}
        - '{{ hostvars[host].ansible_host }}:8091'
{% endfor %}