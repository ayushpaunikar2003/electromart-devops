---
# 1. Install Agents on ALL servers
- name: Deploy Monitoring Agents
  hosts: all
  become: true
  tasks:
    - name: Start Node Exporter
      community.docker.docker_container:
        name: node-exporter
        image: prom/node-exporter:latest
        state: started
        restart_policy: always
        ports:
          - "9100:9100"
        volumes:
          - /proc:/host/proc:ro
          - /sys:/host/sys:ro
          - /:/rootfs:ro
        command:
          - '--path.procfs=/host/proc'
          - '--path.sysfs=/host/sys'
          - '--collector.filesystem.ignored-mount-points=^/(sys|proc|dev|host|etc)($|/)'

    - name: Start cAdvisor
      community.docker.docker_container:
        name: cadvisor
        # We use a specific version known to work well with ARM64
        image: gcr.io/cadvisor/cadvisor:v0.47.0
        state: started
        restart_policy: always
        ports:
          - "8080:8080"
        volumes:
          - /:/rootfs:ro
          - /var/run:/var/run:rw
          - /sys:/sys:ro
          - /var/lib/docker/:/var/lib/docker:ro
        privileged: true

# 2. Install Server Stack on BASTION only
- name: Deploy Prometheus & Grafana Server
  hosts: bastion
  become: true
  tasks:
    - name: Create Prometheus Config Directory
      file:
        path: /etc/prometheus
        state: directory
        mode: '0755'

    - name: Generate Prometheus Config from Template
      template:
        src: templates/prometheus.yml.j2
        dest: /etc/prometheus/prometheus.yml

    - name: Start Prometheus
      community.docker.docker_container:
        name: prometheus
        image: prom/prometheus:latest
        state: started
        restart_policy: always
        ports:
          - "9090:9090"
        volumes:
          - /etc/prometheus/prometheus.yml:/etc/prometheus/prometheus.yml

    - name: Start Grafana
      community.docker.docker_container:
        name: grafana
        image: grafana/grafana:latest
        state: started
        restart_policy: always
        ports:
          - "3000:3000"
