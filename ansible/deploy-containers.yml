---
- name: Deploy Electromart backend & frontend using Docker
  hosts: web:app
  become: true

  vars:
    aws_region: "ap-south-1"
    ecr_registry: "836397457654.dkr.ecr.ap-south-1.amazonaws.com"

    backend_image: "{{ ecr_registry }}/electromart/backend:latest"
    frontend_image: "{{ ecr_registry }}/electromart/frontend:latest"

    backend_container_name: "electromart-backend"
    frontend_container_name: "electromart-frontend"

    backend_port: 8091
    mongo_port: 27017
    mongo_db: "electromart"

    # Dynamic IP retrieval
    mongo_host: "{{ hostvars[groups['db'][0]].ansible_host }}"
    backend_host: "{{ hostvars[groups['app'][0]].ansible_host }}"

  tasks:
    # --------------------- ECR LOGIN ---------------------
    - name: Log in to ECR on target hosts using IAM Role
      shell: |
        aws ecr get-login-password --region {{ aws_region }} | docker login --username AWS --password-stdin {{ ecr_registry }}
      register: login_result
      changed_when: "'Login Succeeded' in login_result.stdout"

    # --------------------- BACKEND (APP SERVER) ---------------------
    - name: Pull backend image
      when: "'app' in group_names"
      shell: docker pull {{ backend_image }}
      register: backend_pull
      changed_when: "'Status: Downloaded' in backend_pull.stdout or 'Image is up to date' in backend_pull.stdout"

    - name: Stop old backend container
      when: "'app' in group_names"
      shell: docker rm -f {{ backend_container_name }} || true

    - name: Run backend container
      when: "'app' in group_names"
      shell: |
        docker run -d \
          --name {{ backend_container_name }} \
          --restart always \
          -p {{ backend_port }}:{{ backend_port }} \
          -e PORT={{ backend_port }} \
          -e MONGO_URI="mongodb://{{ mongo_host }}:{{ mongo_port }}/{{ mongo_db }}" \
          -e FRONTEND_ORIGIN="http://{{ hostvars[groups['web'][0]].inventory_hostname }}" \
          {{ backend_image }}
      # Note: FRONTEND_ORIGIN uses the Public IP (inventory_hostname) so CORS works

    # --------------------- FRONTEND (WEB SERVER) --------------------
    - name: Stop system Nginx (free up port 80)
      when: "'web' in group_names"
      service:
        name: nginx
        state: stopped
        enabled: no
      ignore_errors: yes

    - name: Pull frontend image
      when: "'web' in group_names"
      shell: docker pull {{ frontend_image }}
      register: frontend_pull
      changed_when: "'Status: Downloaded' in frontend_pull.stdout or 'Image is up to date' in frontend_pull.stdout"

    - name: Stop old frontend container
      when: "'web' in group_names"
      shell: docker rm -f {{ frontend_container_name }} || true

    - name: Run frontend container (With Backend Link)
      when: "'web' in group_names"
      shell: |
        docker run -d \
          --name {{ frontend_container_name }} \
          --restart always \
          -p 80:80 \
          -e BACKEND_HOST={{ backend_host }} \
          {{ frontend_image }}
