name: Electromart CI/CD

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

env:
  AWS_REGION: ap-south-1
  ECR_REPO_BACKEND: electromart/backend
  ECR_REPO_FRONTEND: electromart/frontend

jobs:
  # ------------------------------------------------------------------
  # JOB 1: BUILD & PUSH (Now with ARM64 Support!)
  # ------------------------------------------------------------------
  build-and-push:
    name: ðŸ—ï¸ Build & Push (ARM64)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      # 1. Setup QEMU (The Translator for ARM)
      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      # 2. Setup Docker Buildx (The Multi-Arch Builder)
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Login to Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v2

      # 3. Dynamic IP Lookup
      - name: ðŸ” Find Web Server IP (LB_IP)
        id: get-ip
        run: |
          echo "Querying AWS for Web Server Public IP..."
          LB_IP=$(aws ec2 describe-instances \
            --filters "Name=tag:Name,Values=electromart-web-1" "Name=instance-state-name,Values=running" \
            --query "Reservations[].Instances[].PublicIpAddress" \
            --output text)

          if [[ -z "$LB_IP" || "$LB_IP" == "None" ]]; then
            echo "âŒ Error: Could not find Web Server (electromart-web-1). Is it running?"
            exit 1
          fi

          echo "âœ… Found Web IP: $LB_IP"
          echo "LB_IP=$LB_IP" >> $GITHUB_ENV

      # 4. Build Backend for ARM64
      - name: Build & Push Backend
        env:
          ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
          IMAGE_TAG: latest
        run: |
          # The --platform flag tells Docker to target your AWS T4g instances
          docker buildx build --platform linux/arm64 \
            -t $ECR_REGISTRY/$ECR_REPO_BACKEND:$IMAGE_TAG \
            --push ./app/backend

      # 5. Build Frontend for ARM64
      - name: Build & Push Frontend
        env:
          ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
          IMAGE_TAG: latest
        run: |
          echo "Building Frontend for ARM64..."
          docker buildx build --platform linux/arm64 \
            --build-arg REACT_APP_API_URL=http://${{ env.LB_IP }}:5000 \
            -t $ECR_REGISTRY/$ECR_REPO_FRONTEND:$IMAGE_TAG \
            --push ./app/frontend

  # ------------------------------------------------------------------
  # JOB 2: DEPLOY (Same as before)
  # ------------------------------------------------------------------
  deploy:
    name: ðŸš€ Deploy
    needs: build-and-push
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: ðŸ” Find Bastion IP
        id: get-bastion
        run: |
          echo "Querying AWS for Bastion Public IP..."
          BASTION_IP=$(aws ec2 describe-instances \
            --filters "Name=tag:Name,Values=electromart-bastion" "Name=instance-state-name,Values=running" \
            --query "Reservations[].Instances[].PublicIpAddress" \
            --output text)

          if [[ -z "$BASTION_IP" || "$BASTION_IP" == "None" ]]; then
            echo "âŒ Error: Could not find Bastion Server."
            exit 1
          fi

          echo "âœ… Found Bastion IP: $BASTION_IP"
          echo "BASTION_IP=$BASTION_IP" >> $GITHUB_ENV

      - name: Install Ansible
        run: pip install ansible boto3 botocore

      - name: Setup SSH Key
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa

      - name: Generate Inventory
        run: |
          echo "ðŸ” Fetching Private IPs from AWS..."
          WEB_PRIVATE=$(aws ec2 describe-instances --filters "Name=tag:Name,Values=electromart-web-1" --query "Reservations[].Instances[].PrivateIpAddress" --output text)
          APP_PRIVATE=$(aws ec2 describe-instances --filters "Name=tag:Name,Values=electromart-app-1" --query "Reservations[].Instances[].PrivateIpAddress" --output text)
          DB_PRIVATE=$(aws ec2 describe-instances --filters "Name=tag:Name,Values=electromart-db-1" --query "Reservations[].Instances[].PrivateIpAddress" --output text)

          if [[ -z "$WEB_PRIVATE" || -z "$APP_PRIVATE" || -z "$DB_PRIVATE" ]]; then
            echo "âŒ Error: Could not find Private IPs for one or more instances."
            exit 1
          fi

          cd ansible
          cat > inventory.ini <<EOF
          [bastion]
          bastion1 ansible_host=${{ env.BASTION_IP }}

          [web]
          web1 ansible_host=$WEB_PRIVATE

          [app]
          app1 ansible_host=$APP_PRIVATE

          [db]
          db1 ansible_host=$DB_PRIVATE

          [all:vars]
          ansible_user=ubuntu
          ansible_ssh_private_key_file=~/.ssh/id_rsa
          ansible_ssh_common_args='-o StrictHostKeyChecking=no -o IdentitiesOnly=yes'

          [jumped_hosts:children]
          web
          app
          db

          [jumped_hosts:vars]
          ansible_ssh_common_args='-o StrictHostKeyChecking=no -o IdentitiesOnly=yes -o ProxyCommand="ssh -o StrictHostKeyChecking=no -o IdentitiesOnly=yes -i ~/.ssh/id_rsa -W %h:%p -q ubuntu@${{ env.BASTION_IP }}"'
          EOF

      - name: ðŸ› ï¸ 1. Install Docker & Tools
        run: |
          cd ansible
          ansible-playbook -i inventory.ini install-docker.yml

      - name: ðŸ—„ï¸ 2. Deploy Database
        run: |
          cd ansible
          ansible-playbook -i inventory.ini deploy-db.yml

      - name: ðŸš€ 3. Deploy Containers (App)
        run: |
          cd ansible
          ansible-playbook -i inventory.ini deploy-containers.yml

      - name: ðŸ“Š 4. Deploy Monitoring
        run: |
          cd ansible
          ansible-playbook -i inventory.ini deploy-monitoring.yml
